# SuperClaude AI Code Review Pipeline
# Uses Claude Code Action with PAL MCP Consensus Code Review
# Dual Provider: AWS Bedrock (Primary) + Anthropic API (Fallback)
# NON-BLOCKING: Advisory comments only, does not prevent merge

name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Note: This workflow is intentionally non-blocking
# It provides AI-powered feedback but does not gate merges

jobs:
  ai-review:
    name: PAL MCP Consensus Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Skip for dependabot PRs to avoid API costs
    if: github.actor != 'dependabot[bot]'
    continue-on-error: true

    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    env:
      BEDROCK_CONFIGURED: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK != '' }}
      ANTHROPIC_KEY_SET: ${{ secrets.ANTHROPIC_API_KEY != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate provider configuration
        id: validate_providers
        run: |
          if [[ "${{ env.BEDROCK_CONFIGURED }}" != "true" ]] && [[ "${{ env.ANTHROPIC_KEY_SET }}" != "true" ]]; then
            echo "::warning::No Claude API provider configured (AWS Bedrock or Anthropic API). Skipping review."
            echo "skip_review=true" >> $GITHUB_OUTPUT
          else
            echo "skip_review=false" >> $GITHUB_OUTPUT
            echo "Provider check passed:"
            echo "  - Bedrock: ${{ env.BEDROCK_CONFIGURED }}"
            echo "  - Anthropic: ${{ env.ANTHROPIC_KEY_SET }}"
          fi

      - name: Get PR context
        if: steps.validate_providers.outputs.skip_review != 'true'
        id: context
        run: |
          # Get changed files count
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l | tr -d ' ')
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

          # Get diff statistics
          DIFF_STATS=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1)
          echo "diff_stats=$DIFF_STATS" >> $GITHUB_OUTPUT

          # Get list of changed Python files (absolute paths)
          PYTHON_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' | head -20 | sed "s|^|$(pwd)/|" | tr '\n' ',' | sed 's/,$//')
          echo "python_files=$PYTHON_FILES" >> $GITHUB_OUTPUT

          # Check if tests were modified (use wc -l to avoid grep exit code issues)
          TESTS_MODIFIED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^tests/' | wc -l | tr -d ' ')
          echo "tests_modified=${TESTS_MODIFIED:-0}" >> $GITHUB_OUTPUT

      - name: PAL MCP Review (AWS Bedrock - Primary)
        if: steps.validate_providers.outputs.skip_review != 'true' && env.BEDROCK_CONFIGURED == 'true'
        id: bedrock_review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_bedrock: "true"
          show_full_output: true
          max_turns: 20
          prompt: |
            # SuperClaude PR Code Review - PAL MCP Consensus

            **Repository**: ${{ github.repository }}
            **PR Number**: ${{ github.event.pull_request.number }}
            **PR Title**: ${{ github.event.pull_request.title }}
            **Files Changed**: ${{ steps.context.outputs.files_changed }}
            **Diff Stats**: ${{ steps.context.outputs.diff_stats }}
            **Python Files**: ${{ steps.context.outputs.python_files }}
            **Tests Modified**: ${{ steps.context.outputs.tests_modified }}

            ## Instructions

            You are reviewing a pull request for SuperClaude, an AI-enhanced development
            framework for Claude Code. Use PAL MCP's consensus code review to get
            multi-model perspectives on the changes.

            ### Step 1: Get the PR diff
            First, use `gh pr diff ${{ github.event.pull_request.number }}` to examine the changes.

            ### Step 2: Run PAL MCP Consensus Code Review
            Use the `mcp__pal__codereview` tool to perform a comprehensive code review.

            Configure the review with:
            - `review_type`: "full" (covers quality, security, performance, architecture)
            - `relevant_files`: List the changed Python files from the diff
            - Focus areas: security (critical for MCP/AI framework), code quality, testing

            The codereview tool will:
            1. Analyze the code systematically
            2. Identify issues by severity (critical, high, medium, low)
            3. Provide expert validation of findings

            ### Step 3: Post Results
            After the consensus review completes, post the results using `gh pr comment`
            with this format:

            ```markdown
            ## PAL MCP Consensus Code Review (via AWS Bedrock)

            ### Overview
            [Brief summary of changes reviewed]

            ### Critical Issues
            [Any blocking issues - must fix before merge]

            ### High Priority
            [Important issues that should be addressed]

            ### Medium Priority
            [Improvements recommended]

            ### Positive Observations
            [Good patterns and practices observed]

            ### Review Summary
            | Category | Rating |
            |----------|--------|
            | Security | /5 |
            | Code Quality | /5 |
            | Architecture | /5 |
            | Testing | /5 |

            ---
            *This review was generated by PAL MCP Consensus Code Review (AWS Bedrock).*
            *Multiple AI models were consulted to validate findings.*
            *Review is advisory - please use human judgment for final decisions.*
            ```

          claude_args: >-
            --allowed-tools
            "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),mcp__pal__codereview,mcp__pal__consensus"
        env:
          AWS_BEARER_TOKEN_BEDROCK: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
          CLAUDE_CODE_USE_BEDROCK: "1"

      - name: PAL MCP Review (Anthropic API - Fallback)
        if: steps.validate_providers.outputs.skip_review != 'true' && env.ANTHROPIC_KEY_SET == 'true' && (env.BEDROCK_CONFIGURED != 'true' || steps.bedrock_review.outcome != 'success')
        id: anthropic_review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          max_turns: 20
          prompt: |
            # SuperClaude PR Code Review - PAL MCP Consensus

            **Repository**: ${{ github.repository }}
            **PR Number**: ${{ github.event.pull_request.number }}
            **PR Title**: ${{ github.event.pull_request.title }}
            **Files Changed**: ${{ steps.context.outputs.files_changed }}
            **Diff Stats**: ${{ steps.context.outputs.diff_stats }}
            **Python Files**: ${{ steps.context.outputs.python_files }}
            **Tests Modified**: ${{ steps.context.outputs.tests_modified }}

            ## Instructions

            You are reviewing a pull request for SuperClaude, an AI-enhanced development
            framework for Claude Code. Use PAL MCP's consensus code review to get
            multi-model perspectives on the changes.

            ### Step 1: Get the PR diff
            First, use `gh pr diff ${{ github.event.pull_request.number }}` to examine the changes.

            ### Step 2: Run PAL MCP Consensus Code Review
            Use the `mcp__pal__codereview` tool to perform a comprehensive code review.

            Configure the review with:
            - `review_type`: "full" (covers quality, security, performance, architecture)
            - `relevant_files`: List the changed Python files from the diff
            - Focus areas: security (critical for MCP/AI framework), code quality, testing

            The codereview tool will:
            1. Analyze the code systematically
            2. Identify issues by severity (critical, high, medium, low)
            3. Provide expert validation of findings

            ### Step 3: Post Results
            After the consensus review completes, post the results using `gh pr comment`
            with this format:

            ```markdown
            ## PAL MCP Consensus Code Review (via Anthropic API - Fallback)

            ### Overview
            [Brief summary of changes reviewed]

            ### Critical Issues
            [Any blocking issues - must fix before merge]

            ### High Priority
            [Important issues that should be addressed]

            ### Medium Priority
            [Improvements recommended]

            ### Positive Observations
            [Good patterns and practices observed]

            ### Review Summary
            | Category | Rating |
            |----------|--------|
            | Security | /5 |
            | Code Quality | /5 |
            | Architecture | /5 |
            | Testing | /5 |

            ---
            *This review was generated by PAL MCP Consensus Code Review (Anthropic API - Fallback).*
            *Multiple AI models were consulted to validate findings.*
            *Review is advisory - please use human judgment for final decisions.*
            ```

          claude_args: >-
            --allowed-tools
            "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),mcp__pal__codereview,mcp__pal__consensus"

      - name: Review status
        if: always()
        run: |
          echo "## PAL MCP Consensus Code Review Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.validate_providers.outputs.skip_review }}" == "true" ]]; then
            echo "**Status**: Skipped - No providers configured" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          BEDROCK_STATUS="${{ steps.bedrock_review.outcome || 'skipped' }}"
          ANTHROPIC_STATUS="${{ steps.anthropic_review.outcome || 'skipped' }}"

          echo "| Provider | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| AWS Bedrock (Primary) | $BEDROCK_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Anthropic API (Fallback) | $ANTHROPIC_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$BEDROCK_STATUS" == "success" ]] || [[ "$ANTHROPIC_STATUS" == "success" ]]; then
            echo "**Result**: Multi-model consensus code review posted to PR" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Result**: Review failed (both providers)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Features:**" >> $GITHUB_STEP_SUMMARY
          echo "- Full review covering security, quality, performance, architecture" >> $GITHUB_STEP_SUMMARY
          echo "- Issues categorized by severity (critical/high/medium/low)" >> $GITHUB_STEP_SUMMARY
          echo "- Expert model validation of findings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: This review is advisory only and does not block merging." >> $GITHUB_STEP_SUMMARY
