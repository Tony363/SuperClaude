# SuperClaude AI Code Review Pipeline
# Uses Claude Code Action with PAL MCP for enhanced code review
# NON-BLOCKING: Advisory comments only, does not prevent merge

name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Note: This workflow is intentionally non-blocking
# It provides AI-powered feedback but does not gate merges

jobs:
  ai-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    # Skip for dependabot PRs to avoid API costs
    if: github.actor != 'dependabot[bot]'

    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR context
        id: context
        run: |
          # Get changed files count
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

          # Get diff statistics
          DIFF_STATS=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1)
          echo "diff_stats=$DIFF_STATS" >> $GITHUB_OUTPUT

          # Get list of changed Python files
          PYTHON_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' | head -20 | tr '\n' ' ')
          echo "python_files=$PYTHON_FILES" >> $GITHUB_OUTPUT

          # Check if tests were modified
          TESTS_MODIFIED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -c '^tests/' || echo "0")
          echo "tests_modified=$TESTS_MODIFIED" >> $GITHUB_OUTPUT

      - name: Run Claude Code Review with PAL MCP
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: 10
          prompt: |
            # SuperClaude PR Code Review

            **Repository**: ${{ github.repository }}
            **PR Number**: ${{ github.event.pull_request.number }}
            **PR Title**: ${{ github.event.pull_request.title }}
            **Files Changed**: ${{ steps.context.outputs.files_changed }}
            **Diff Stats**: ${{ steps.context.outputs.diff_stats }}
            **Python Files**: ${{ steps.context.outputs.python_files }}
            **Tests Modified**: ${{ steps.context.outputs.tests_modified }}

            ## Instructions

            You are reviewing a pull request for SuperClaude, an AI-enhanced development
            framework for Claude Code. Please perform a thorough code review.

            ### Review Focus Areas

            1. **Code Quality**
               - Python best practices and PEP 8 compliance
               - Type hints usage and consistency
               - Clear naming and documentation
               - DRY principle adherence

            2. **Security** (Critical for MCP/AI framework)
               - Input validation and sanitization
               - Secret handling (no hardcoded credentials)
               - Safe subprocess usage
               - API key protection

            3. **Architecture**
               - Consistency with existing patterns in SuperClaude/
               - Proper separation of concerns
               - MCP integration patterns

            4. **Testing**
               - Test coverage for new functionality
               - Edge case handling
               - Mock usage for external dependencies

            5. **Performance**
               - Async/await best practices
               - Resource cleanup
               - Caching considerations

            ### Review Output

            Use `gh pr diff` to examine the changes, then post a structured review
            using `gh pr comment` with the following format:

            ```markdown
            ## AI Code Review Summary

            ### Overview
            [Brief summary of changes]

            ### Critical Issues
            [List any blocking issues that should be addressed before merge]

            ### Suggestions
            [Non-blocking improvements that would enhance code quality]

            ### Positive Observations
            [Good patterns and practices observed in the PR]

            ### Test Coverage
            [Assessment of test coverage for changes]

            ---
            *This review was generated by Claude Code with PAL MCP tools.*
            *Review is advisory - please use human judgment for final decisions.*
            ```

          claude_args: >-
            --allowed-tools
            "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh issue view:*),Bash(gh issue list:*),Bash(gh search:*)"

      - name: Review complete
        if: always()
        run: |
          echo "## AI Review Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "AI code review has been posted to the PR." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: This review is advisory only and does not block merging." >> $GITHUB_STEP_SUMMARY
