# SuperClaude AI Code Review Pipeline
# Uses Claude Code Action with PAL MCP Consensus Code Review
# NON-BLOCKING: Advisory comments only, does not prevent merge

name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Note: This workflow is intentionally non-blocking
# It provides AI-powered feedback but does not gate merges

jobs:
  ai-review:
    name: PAL MCP Consensus Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Skip for dependabot PRs to avoid API costs
    if: github.actor != 'dependabot[bot]'

    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR context
        id: context
        run: |
          # Get changed files count
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

          # Get diff statistics
          DIFF_STATS=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1)
          echo "diff_stats=$DIFF_STATS" >> $GITHUB_OUTPUT

          # Get list of changed Python files (absolute paths)
          PYTHON_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' | head -20 | sed "s|^|$(pwd)/|" | tr '\n' ',' | sed 's/,$//')
          echo "python_files=$PYTHON_FILES" >> $GITHUB_OUTPUT

          # Check if tests were modified (use wc -l to avoid grep exit code issues)
          TESTS_MODIFIED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^tests/' | wc -l | tr -d ' ')
          echo "tests_modified=${TESTS_MODIFIED:-0}" >> $GITHUB_OUTPUT

      - name: Run PAL MCP Consensus Code Review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # SuperClaude PR Code Review - PAL MCP Consensus

            **Repository**: ${{ github.repository }}
            **PR Number**: ${{ github.event.pull_request.number }}
            **PR Title**: ${{ github.event.pull_request.title }}
            **Files Changed**: ${{ steps.context.outputs.files_changed }}
            **Diff Stats**: ${{ steps.context.outputs.diff_stats }}
            **Python Files**: ${{ steps.context.outputs.python_files }}
            **Tests Modified**: ${{ steps.context.outputs.tests_modified }}

            ## Instructions

            You are reviewing a pull request for SuperClaude, an AI-enhanced development
            framework for Claude Code. Use PAL MCP's consensus code review to get
            multi-model perspectives on the changes.

            ### Step 1: Get the PR diff
            First, use `gh pr diff ${{ github.event.pull_request.number }}` to examine the changes.

            ### Step 2: Run PAL MCP Consensus Code Review
            Use the `mcp__pal__codereview` tool to perform a comprehensive code review.

            Configure the review with:
            - `review_type`: "full" (covers quality, security, performance, architecture)
            - `relevant_files`: List the changed Python files from the diff
            - Focus areas: security (critical for MCP/AI framework), code quality, testing

            The codereview tool will:
            1. Analyze the code systematically
            2. Identify issues by severity (critical, high, medium, low)
            3. Provide expert validation of findings

            ### Step 3: Post Results
            After the consensus review completes, post the results using `gh pr comment`
            with this format:

            ```markdown
            ## ðŸ¤– PAL MCP Consensus Code Review

            ### Overview
            [Brief summary of changes reviewed]

            ### ðŸ”´ Critical Issues
            [Any blocking issues - must fix before merge]

            ### ðŸŸ  High Priority
            [Important issues that should be addressed]

            ### ðŸŸ¡ Medium Priority
            [Improvements recommended]

            ### ðŸŸ¢ Positive Observations
            [Good patterns and practices observed]

            ### ðŸ“Š Review Summary
            | Category | Rating |
            |----------|--------|
            | Security | â­â­â­â­â˜† |
            | Code Quality | â­â­â­â­â˜† |
            | Architecture | â­â­â­â­â˜† |
            | Testing | â­â­â­â˜†â˜† |

            ---
            *This review was generated by PAL MCP Consensus Code Review.*
            *Multiple AI models were consulted to validate findings.*
            *Review is advisory - please use human judgment for final decisions.*
            ```

          claude_args: >-
            --allowed-tools
            "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),mcp__pal__codereview,mcp__pal__consensus"

      - name: Review complete
        if: always()
        run: |
          echo "## ðŸ¤– PAL MCP Consensus Code Review Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Multi-model consensus code review has been posted to the PR." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Features:**" >> $GITHUB_STEP_SUMMARY
          echo "- Full review covering security, quality, performance, architecture" >> $GITHUB_STEP_SUMMARY
          echo "- Issues categorized by severity (critical/high/medium/low)" >> $GITHUB_STEP_SUMMARY
          echo "- Expert model validation of findings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: This review is advisory only and does not block merging." >> $GITHUB_STEP_SUMMARY
