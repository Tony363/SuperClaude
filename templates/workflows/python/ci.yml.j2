# {{ project_name }} CI Pipeline
# Generated by SuperClaude /sc:cicd-setup
# Quality gates with matrix testing across Python {{ python_versions | join(', ') }}

name: CI

on:
  push:
    branches: [{{ main_branch }}, develop]
  pull_request:
    branches: ['**']

permissions:
  contents: read

jobs:
  # ============================================
  # Quality Gate - Fast fail on style/lint issues
  # ============================================
  quality:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Set up Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: '{{ python_versions[-1] }}'
          cache: 'pip'

      - name: Install quality tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy{% if type_stubs %} {{ type_stubs | join(' ') }}{% endif %}

      - name: Ruff lint check
        run: ruff check . --output-format=github

      - name: Ruff format check
        run: ruff format --check .

      - name: MyPy type check
        run: mypy {{ source_dir }} --ignore-missing-imports || echo "::warning::MyPy found type issues"
        continue-on-error: {{ mypy_non_blocking | default(true) | lower }}

  # ============================================
  # Test Matrix - Python {{ python_versions | join(' through ') }}
  # ============================================
  test:
    name: Test (Python {% raw %}${{ matrix.python-version }}{% endraw %})
    needs: quality
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: {{ python_versions | tojson }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Set up Python {% raw %}${{ matrix.python-version }}{% endraw %}
        uses: actions/setup-python@v5.3.0
        with:
          python-version: {% raw %}${{ matrix.python-version }}{% endraw %}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ".[test]"
          pip install pytest-cov pytest-asyncio

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov={{ source_dir }} \
            --cov-report=xml \
            --cov-report=term-missing \
            --tb=short \
            -v

      - name: Upload coverage artifact
        if: matrix.python-version == '{{ python_versions[0] }}'
        uses: actions/upload-artifact@v4.4.3
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 7
{% if codecov %}

      - name: Upload coverage to Codecov
        if: matrix.python-version == '{{ python_versions[0] }}'
        uses: codecov/codecov-action@v5.1.2
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: {% raw %}${{ secrets.CODECOV_TOKEN }}{% endraw %}
{% endif %}
{% if coverage_threshold %}

  # ============================================
  # Coverage Gate - {{ coverage_threshold }}% threshold
  # ============================================
  coverage-gate:
    name: Coverage Gate ({{ coverage_threshold }}%)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Set up Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: '{{ python_versions[-1] }}'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ".[test]"
          pip install pytest-cov

      - name: Check coverage threshold
        run: |
          pytest tests/ \
            --cov={{ source_dir }} \
            --cov-fail-under={{ coverage_threshold }} \
            --tb=short \
            -q
{% endif %}

  # ============================================
  # Build Verification - Ensure package builds
  # ============================================
  build:
    name: Build Check
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Set up Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: '{{ python_versions[-1] }}'
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package with twine
        run: twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.4.3
        with:
          name: dist
          path: dist/
          retention-days: 7

  # ============================================
  # CI Summary - Aggregate status
  # ============================================
  ci-status:
    name: CI Status
    if: always()
    needs: [quality, test, build{% if coverage_threshold %}, coverage-gate{% endif %}]
    runs-on: ubuntu-latest
    steps:
      - name: Check CI status
        run: |
          if [[ "{% raw %}${{ needs.quality.result }}{% endraw %}" == "failure" ]] || \
             [[ "{% raw %}${{ needs.test.result }}{% endraw %}" == "failure" ]] || \
             [[ "{% raw %}${{ needs.build.result }}{% endraw %}" == "failure" ]]{% if coverage_threshold %} || \
             [[ "{% raw %}${{ needs.coverage-gate.result }}{% endraw %}" == "failure" ]]{% endif %}; then
            echo "CI failed"
            exit 1
          fi
          echo "CI passed"
