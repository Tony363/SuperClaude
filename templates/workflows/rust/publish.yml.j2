# {{ project_name }} crates.io Publish Pipeline
# Generated by SuperClaude /sc:cicd-setup

name: Publish to crates.io

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (validate without publishing)'
        required: true
        default: 'true'
        type: boolean

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify package
        run: cargo package --list

      - name: Dry run publish
        if: github.event.inputs.dry_run == 'true' || github.event_name != 'release'
        run: cargo publish --dry-run

      - name: Publish to crates.io
        if: github.event_name == 'release' || github.event.inputs.dry_run == 'false'
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: {% raw %}${{ secrets.CARGO_REGISTRY_TOKEN }}{% endraw %}

      - name: Create deployment summary
        if: always()
        run: |
          echo "## crates.io Package Deployment" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | {% raw %}${{ github.event.inputs.dry_run || 'false' }}{% endraw %} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | {% raw %}${{ github.event_name }}{% endraw %} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | {% raw %}${{ github.sha }}{% endraw %} |" >> $GITHUB_STEP_SUMMARY
