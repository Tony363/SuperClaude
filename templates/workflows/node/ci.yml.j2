# {{ project_name }} CI Pipeline
# Generated by SuperClaude /sc:cicd-setup
# Quality gates with matrix testing across Node.js {{ node_versions | join(', ') }}

name: CI

on:
  push:
    branches: [{{ main_branch }}, develop]
  pull_request:
    branches: ['**']

permissions:
  contents: read

jobs:
  # ============================================
  # Quality Gate - Lint and type check
  # ============================================
  quality:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: '{{ node_versions[-1] }}'
          cache: '{{ package_manager }}'

      - name: Install dependencies
        run: {{ package_manager }} {{ 'install' if package_manager == 'npm' else 'install' }}

      - name: Run linter
        run: {{ package_manager }} run lint

      - name: Check formatting
        run: {{ package_manager }} run format:check || true

      - name: Type check
        run: {{ package_manager }} run typecheck || true

  # ============================================
  # Test Matrix - Node.js {{ node_versions | join(', ') }}
  # ============================================
  test:
    name: Test (Node {% raw %}${{ matrix.node-version }}{% endraw %})
    needs: quality
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: {{ node_versions | tojson }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Setup Node.js {% raw %}${{ matrix.node-version }}{% endraw %}
        uses: actions/setup-node@v4.1.0
        with:
          node-version: {% raw %}${{ matrix.node-version }}{% endraw %}
          cache: '{{ package_manager }}'

      - name: Install dependencies
        run: {{ package_manager }} {{ 'ci' if package_manager == 'npm' else 'install --frozen-lockfile' if package_manager == 'yarn' else 'install --frozen-lockfile' }}

      - name: Run tests
        run: {{ package_manager }} test

      - name: Run tests with coverage
        if: matrix.node-version == '{{ node_versions[0] }}'
        run: {{ package_manager }} run test:coverage || {{ package_manager }} test -- --coverage
{% if codecov %}

      - name: Upload coverage to Codecov
        if: matrix.node-version == '{{ node_versions[0] }}'
        uses: codecov/codecov-action@v5.1.2
        with:
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: {% raw %}${{ secrets.CODECOV_TOKEN }}{% endraw %}
{% endif %}

  # ============================================
  # Build Verification
  # ============================================
  build:
    name: Build Check
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: '{{ node_versions[-1] }}'
          cache: '{{ package_manager }}'

      - name: Install dependencies
        run: {{ package_manager }} {{ 'ci' if package_manager == 'npm' else 'install --frozen-lockfile' }}

      - name: Build
        run: {{ package_manager }} run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.4.3
        with:
          name: dist
          path: dist/
          retention-days: 7

  # ============================================
  # CI Summary
  # ============================================
  ci-status:
    name: CI Status
    if: always()
    needs: [quality, test, build]
    runs-on: ubuntu-latest
    steps:
      - name: Check CI status
        run: |
          if [[ "{% raw %}${{ needs.quality.result }}{% endraw %}" == "failure" ]] || \
             [[ "{% raw %}${{ needs.test.result }}{% endraw %}" == "failure" ]] || \
             [[ "{% raw %}${{ needs.build.result }}{% endraw %}" == "failure" ]]; then
            echo "CI failed"
            exit 1
          fi
          echo "CI passed"
