#!/bin/bash
# post-merge hook: auto-delete merged local branches after git pull
#
# This hook runs after every successful merge (including git pull).
# It cleans up local branches that:
#   1. Are fully merged into the current branch
#   2. Have had their remote tracking branch deleted (PR merged)
#   3. Are NOT protected branches (main, master, develop)

set -e

# Prune stale remote-tracking branches
git fetch --prune origin 2>/dev/null || true

# Get protected branches (space-separated)
PROTECTED="main master develop"

# Delete local branches whose remote is gone and are merged
git branch --merged 2>/dev/null | grep -v "^\*" | while read -r branch; do
  # Trim whitespace
  branch=$(echo "$branch" | xargs)

  # Skip empty
  [ -z "$branch" ] && continue

  # Skip protected branches
  for protected in $PROTECTED; do
    [ "$branch" = "$protected" ] && continue 2
  done

  # Only delete if remote tracking branch is gone
  if ! git show-ref --verify --quiet "refs/remotes/origin/$branch" 2>/dev/null; then
    if git branch -d "$branch" 2>/dev/null; then
      echo "Cleaned up merged branch: $branch"
    fi
  fi
done

exit 0
